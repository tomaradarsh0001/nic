// Function for displaying calendar 
// Minified by Swati Mishra at 12-02-2025
const appointmentDateElement=document.getElementById("app_appointment_date"),timeSlotDiv=document.getElementById("app_timeSlotDiv"),meetingTimeElement=document.getElementById("app_meeting_time");if(appointmentDateElement){let e=[],t=[],l=[],a=[];Promise.all([fetch("/appointments/get-fully-booked-dates").then(e=>e.json()),fetch("/appointments/get-holidays").then(e=>e.json())]).then(([n,s])=>{let i=new Date,d=i.getDay();e=n.fullyBookedDates.filter(e=>{let t=new Date(e);return t>=i}).map(e=>{let t=new Date(e);return t.getFullYear()+"-"+("0"+(t.getMonth()+1)).slice(-2)+"-"+("0"+t.getDate()).slice(-2)}),a=s.map(e=>{let t=new Date(e);return t.getFullYear()+"-"+("0"+(t.getMonth()+1)).slice(-2)+"-"+("0"+t.getDate()).slice(-2)}),console.log("Fully booked dates:",e),console.log("Holidays:",a);let o={};e.forEach(e=>{let t=new Date(e),l=getStandardWeekNumber(t),a=t.getDay();a>=3&&a<=5&&(o[l]||(o[l]=new Set),o[l].add(a))});let g=getStandardWeekNumber(i);t=Object.keys(o).filter(e=>{let t=o[e],l=new Date(i),n=new Date(i),s=new Date(i);l.setDate(i.getDate()-i.getDay()+3),n.setDate(i.getDate()-i.getDay()+4),s.setDate(i.getDate()-i.getDay()+5);let d=l.toISOString().split("T")[0],c=n.toISOString().split("T")[0],r=s.toISOString().split("T")[0];if(e==g){let u=(t.has(3)||isPastEligibleDay(l,i)||a.includes(d))&&(t.has(4)||isPastEligibleDay(n,i)||a.includes(c))&&(t.has(5)||isPastEligibleDay(s,i)||a.includes(r));return u}return(t.has(3)||a.includes(d))&&(t.has(4)||a.includes(c))&&(t.has(5)||a.includes(r))}),console.log("Fully booked weeks:",t),l=calculateAvailableWeeks(i,d,t,4),console.log("Available weeks:",l);let c=getEndDateFromAvailableWeeks(i,l);flatpickr(appointmentDateElement,{dateFormat:"Y-m-d",minDate:"today",maxDate:c,enable:[function(t){let n=getStandardWeekNumber(t),s=t.getFullYear(),d=("0"+(t.getMonth()+1)).slice(-2),o=("0"+t.getDate()).slice(-2),g=`${s}-${d}-${o}`;if(t<i)return!1;let r=3===t.getDay()||4===t.getDay()||5===t.getDay(),u=e.includes(g),D=a.includes(g),y=l.includes(n);return t<=c&&t>=i&&r&&!u&&!D&&y&&t>=i}],onDayCreate:function(t,n,s,i){let d=new Date(i.dateObj),o=new Date;o.setHours(0,0,0,0);let g=d.getFullYear(),c=("0"+(d.getMonth()+1)).slice(-2),r=("0"+d.getDate()).slice(-2),u=`${g}-${c}-${r}`;d<=o&&isPastEligibleDay(d,o)&&i.classList.add("past-eligible-day"),d<o&&(i.classList.remove("fully-booked-date"),i.classList.add("flatpickr-disabled"),i.disabled=!0),e.includes(u)&&i.classList.add("fully-booked-date"),a.includes(u)&&i.classList.add("holiday-date");let D=getStandardWeekNumber(d),y=3===d.getDay()||4===d.getDay()||5===d.getDay(),m=e.includes(u),p=a.includes(u),h=l.includes(D);y&&!m&&!p&&h&&d>o&&i.classList.add("available-date")},onChange:function(e,t){t&&fetchAvailableTimeSlots(t)}})}).catch(e=>{console.error("Error fetching fully booked dates or holidays:",e)})}


// Function to calculate the end date from available weeks
// Minified by Swati Mishra at 12-02-2025
function getEndDateFromAvailableWeeks(e,t){if(0===t.length)return e;const n=t[t.length-1],a=new Date(e);return a.setDate(e.getDate()+7*(n-getStandardWeekNumber(e))+(6-e.getDay())),a}

// Check if the day is a past eligible day
// Minified by Swati Mishra at 12-02-2025
function isPastEligibleDay(e,t){const a=t.getDay(),D=e.getDay(),n=[3,4,5].includes(D),s=e<=t;let g=new Date(t);g.setDate(t.getDate()-a+(0===a?-6:1));let i=new Date(g);return i.setDate(g.getDate()+6),n&&s&&e>=g&&e<=i}

// Minified by Swati Mishra at 12-02-2025
function fetchAvailableTimeSlots(e){fetch(`/appointments/get-available-time-slots?date=${e}`).then((e=>e.json())).then((e=>{meetingTimeElement.innerHTML='<option value="">Select a time slot</option>',e.length>0?(e.forEach((e=>{let t=document.createElement("option");t.value=e,t.textContent=e,meetingTimeElement.appendChild(t)})),timeSlotDiv.style.display="block"):timeSlotDiv.style.display="none"})).catch((e=>console.error("Error fetching time slots:",e)))}

// Function to calculate the standard week number (Monday-Sunday)
// Minified by Swati Mishra at 12-02-2025
function getStandardWeekNumber(e){const t=new Date(e),a=new Date(t.getFullYear(),0,1),n=t-a,r=Math.floor(n/864e5)+1,l=a.getDay(),o=0===l?1:0;return Math.ceil((r+l-o)/7)}

// Function to calculate available weeks (excluding past and fully booked weeks)
// Minified by Swati Mishra at 12-02-2025
function calculateAvailableWeeks(e,t,a,n){let s=[],c=0;t>=5&&(c=1);const l=getStandardWeekNumber(e);for(;s.length<n;){const t=l+c,n=new Date(e);n.setDate(e.getDate()+7*c-e.getDay());const D=new Date(n);D.setDate(n.getDate()+6),!a.includes(String(t))&&D>=e&&s.push(t),c++}return s}

// OTP Input Management Logic
// Minified by Swati Mishra at 12-02-2025
const setupForm=(e,t)=>{const n=document.getElementById(e),a=[...n.querySelectorAll("input[type=text]")],l=n.querySelector(t),s=e=>{const t=a.indexOf(e.target);/^[0-9]{1}$/.test(e.key)||"Backspace"===e.key||"Delete"===e.key||"Tab"===e.key||e.metaKey||e.preventDefault(),("Delete"===e.key||"Backspace"===e.key)&&t>=0&&(""===a[t].value?t>0&&(a[t-1].focus(),a[t-1].value=""):a[t].value="",e.preventDefault())},c=e=>{const{target:t}=e,n=a.indexOf(t);t.value&&n<a.length-1?a[n+1].focus():n===a.length-1&&l.focus()},r=e=>{e.target.select()},u=e=>{e.preventDefault();const t=e.clipboardData.getData("text");if(!/^[0-9]{1,}$/.test(t))return;const n=t.split("").slice(0,a.length);a.forEach(((e,t)=>e.value=n[t]||"")),n.length===a.length&&l.focus()};a.forEach((e=>{e.addEventListener("input",c),e.addEventListener("keydown",s),e.addEventListener("focus",r),e.addEventListener("paste",u)}))};

// Initialize setupForm for OTP forms
// Minified by Swati Mishra at 12-02-2025
setupForm("app-otp-form","#appVerifyMobileOtpBtn"),setupForm("app-otp-form-email","#appVerifyEmailOtpBtn");var app_meetingPurpose=document.getElementById("app_meetingPurpose");app_meetingPurpose.addEventListener("change",(function(){document.getElementById("app_meetingDescriptionDiv").style.display=""!==this.value?"block":"none"}));

// Appointment Form Validation
// Minified by Swati Mishra at 12-02-2025
$(document).ready((function(){function e(){$("#app_Yes").is(":checked")?($("#app_ifyes").show(),$("#app_ifYesNotChecked").hide()):($("#app_ifyes").hide(),$("#app_ifYesNotChecked").show())}function r(){$("#app_isStakeholder").is(":checked")?$("#app_ifStakeholder").show():$("#app_ifStakeholder").hide()}$("#app_AppointmentSubmitButton").click((function(e){e.preventDefault();var r=document.getElementById("appointment_form");(function(){let e=null,r=!0;[{id:"#app_fullname",errorId:"#app_fullnameError"},{id:"#app_mobile",errorId:"#app_mobileError"},{id:"#app_email",errorId:"#app_emailError"},{id:"#app_pan_number",errorId:"#app_panNumberError"}].forEach((function(i){const o=$(i.id),t=$(i.errorId);o.on("input",(function(){""!==o.val().trim()&&(o.removeClass("required"),t.hide())})),""===o.val().trim()?(o.addClass("required"),t.text("This field is required").show(),r=!1,null===e&&(e=o)):(o.removeClass("required"),t.hide())}));const i=$("#app_mobile"),o=$("#app_mobileError"),t=i.attr("data-id");function a(){const a=i.val().trim();""===a?(o.text("Mobile Number is required"),o.show(),r=!1,null===e&&(e=i)):10!==a.length?(o.text("Mobile Number must be exactly 10 digits"),o.show(),r=!1,null===e&&(e=i)):"0"===t?(o.text("Please verify your mobile number"),o.show(),r=!1,null===e&&(e=i)):o.hide()}a(),i.on("input",(function(){""!==i.val().trim()&&(e=null),a()}));const l=$("#app_email"),n=$("#app_emailError"),p=l.val().trim(),d=l.attr("data-id");""===p?(n.text("Email is required"),n.show(),r=!1,null===e&&(e=l)):"0"===d?(n.text("Please verify your email"),n.show(),r=!1,null===e&&(e=l)):n.hide();const s=$("#app_pan_number"),u=$("#app_panNumberError"),m=s.val().trim();""===m?(s.addClass("required"),u.text("This field is required").show(),r=!1,null===e&&(e=s)):10!==m.length?(s.addClass("required"),u.text("PAN Number must be exactly 10 characters").show(),r=!1,null===e&&(e=s)):(s.removeClass("required"),u.hide());if($("#app_Yes").is(":checked")){[{id:"#app_localityFill",errorId:"#app_localityFillError"},{id:"#app_blocknoFill",errorId:"#app_blocknoFillError"},{id:"#app_plotnoFill",errorId:"#app_plotnoFillError"}].forEach((function(i){const o=$(i.id),t=$(i.errorId);o.on("input",(function(){""!==o.val().trim()&&(o.removeClass("required"),t.hide())})),""===o.val().trim()?(o.addClass("required"),t.text("This field is required").show(),r=!1,null===e&&(e=o)):(o.removeClass("required"),t.hide())}))}else{[{id:"#app_locality",errorId:"#app_localityError"},{id:"#app_block",errorId:"#app_blockError"},{id:"#app_plot",errorId:"#app_plotError"}].forEach((function(i){const o=$(i.id),t=$(i.errorId);o.on("input",(function(){""!==o.val().trim()&&(o.removeClass("required"),t.hide())})),""===o.val().trim()?(o.addClass("required"),t.text("This field is required").show(),r=!1,null===e&&(e=o)):(o.removeClass("required"),t.hide())}))}if($("#app_isStakeholder").is(":checked")){const w=$("#app_stakeholderProof"),I=$("#app_stakeholderProofError");function c(){const i=w[0].files;let o=!1,t=!0;if(i.length>0){o=!0;for(let e=0;e<i.length;e++){if(!i[e].name.endsWith(".pdf")){t=!1;break}}}o?t?(w.removeClass("required"),I.hide()):(w.addClass("required"),I.text("Only PDF file is allowed").show(),r=!1,null===e&&(e=w)):(w.addClass("required"),I.text("File is required").show(),r=!1,null===e&&(e=w))}c(),w.on("change",(function(){e=null,c()}))}[{id:"#app_natureOfVisit",errorId:"#app_natureOfVisitError"},{id:"#app_meetingPurpose",errorId:"#app_meetingPurposeError"},{id:"#app_appointment_date",errorId:"#app_appointmentDateError"}].forEach((function(i){const o=$(i.id),t=$(i.errorId);o.on("input",(function(){""!==o.val().trim()&&(o.removeClass("required"),t.hide())})),""===o.val().trim()?(o.addClass("required"),t.text("This field is required").show(),r=!1,null===e&&(e=o)):(o.removeClass("required"),t.hide())}));const h=$("#app_meetingPurpose"),_=$("#app_meetingDescription"),f=$("#app_meetingDescriptionError");function v(){const i=h.val().trim(),o=_.val().trim();""!==i&&""===o?(f.text("Meeting Description is required"),f.show(),_.addClass("required"),r=!1,null===e&&(e=_)):(f.hide(),_.removeClass("required"))}v(),h.on("input",v),_.on("input",(function(){""!==_.val().trim()&&(e=null),v()}));const q=$("#app_appointment_date"),E=$("#app_meeting_time"),b=q.val().trim(),C=E.val().trim(),k=$("#app_meetingTimeError");""!==b&&""===C?(k.text("Time Slot is required"),k.show(),E.addClass("required"),r=!1,null===e&&(e=E)):(k.hide(),E.removeClass("required"));null!==e&&e.focus();return r})()&&r.submit()})),e(),$("#app_Yes").change((function(){e()})),r(),$("#app_isStakeholder").change((function(){r()}))}));